#include <Trade/Trade.mqh>
CTrade trade;

input double lots             = 0.01;
input int emaFast             = 36;     // EMA36
input int emaSlow             = 200;    // EMA200

input int tpFirst             = 1000;
input int slFirst             = 1000;
input int breakEvenFirst      = 500;
input int breakEvenOffset     = 50;

input int tpAddOn             = 500;
input int slAddOn             = 1000;
input int breakEvenAddOn2     = 200;

double lastBuyPrice1 = 0;
double lastBuyPrice2 = 0;

// อ่าน EMA
double GetEMA(int period, int shift)
{
    double buffer[];
    int handle = iMA(_Symbol, PERIOD_M15, period, 0, MODE_EMA, PRICE_CLOSE);
    if(CopyBuffer(handle,0,shift,1,buffer)>0)
        return buffer[0];
    return 0;
}

// ตรวจ EMA36 ตัด EMA200 ขึ้น
bool IsEMACrossUp()
{
    double emaFastPrev = GetEMA(emaFast,1);
    double emaSlowPrev = GetEMA(emaSlow,1);
    double emaFastNow  = GetEMA(emaFast,0);
    double emaSlowNow  = GetEMA(emaSlow,0);

    return (emaFastPrev < emaSlowPrev) && (emaFastNow > emaSlowNow);
}

// SL กันหน้าไม้
void BreakEven(double priceOpen, ulong ticket, int trigger)
{
    double bid = SymbolInfoDouble(_Symbol, SYMBOL_BID);
    double slCurrent = PositionGetDouble(POSITION_SL);
    double distance = bid - priceOpen;

    if(distance >= trigger * _Point)
    {
        double newSL = priceOpen + breakEvenOffset * _Point;
        if(newSL > slCurrent)
            trade.PositionModify(ticket, newSL, PositionGetDouble(POSITION_TP));
    }
}

void OnTick()
{
    double bid = SymbolInfoDouble(_Symbol, SYMBOL_BID);

    // เปิดไม้แรก ถ้า EMA36 ตัด EMA200 ขึ้น
    if(lastBuyPrice1 == 0 && IsEMACrossUp())
    {
        double price = SymbolInfoDouble(_Symbol, SYMBOL_ASK);
        trade.Buy(lots, _Symbol, price, price - slFirst*_Point, price + tpFirst*_Point);
        lastBuyPrice1 = price;
        lastBuyPrice2 = 0; // รีเซ็ตไม้2
    }

    // ปรับ SL กันหน้าไม้ไม้แรกและไม้สอง
    for(int i=0;i<PositionsTotal();i++)
    {
        ulong ticket = PositionGetTicket(i);
        if(PositionSelectByTicket(ticket))
        {
            double openPrice = PositionGetDouble(POSITION_PRICE_OPEN);
            if(openPrice == lastBuyPrice1)
                BreakEven(lastBuyPrice1, ticket, breakEvenFirst);
            if(openPrice == lastBuyPrice2)
                BreakEven(lastBuyPrice2, ticket, breakEvenAddOn2);
        }
    }

    // เปิดไม้สอง ถ้าราคาลง 500 จุดจากไม้แรก
    if(lastBuyPrice1 > 0 && lastBuyPrice2 == 0 && bid <= lastBuyPrice1 - 500*_Point)
    {
        double price = SymbolInfoDouble(_Symbol, SYMBOL_ASK);
        trade.Buy(lots, _Symbol, price, price - slAddOn*_Point, price + tpAddOn*_Point);
        lastBuyPrice2 = price;
    }
}
