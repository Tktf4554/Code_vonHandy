#include <Trade/Trade.mqh>
CTrade trade;

input double lots1            = 0.2;    
input double lots2            = 0.2;    
input int emaPeriod           = 36;     
input int tpFirst             = 1000;
input int slFirst             = 1000;
input int breakEvenFirst      = 500;
input int breakEvenOffset     = 50;

input int tpAddOn             = 500;
input int slAddOn             = 1000;
input int breakEvenAddOn2     = 200;

double lastBuyPrice1 = 0;
double lastBuyPrice2 = 0;

// อ่าน EMA36
double GetEMA(int period,int shift)
{
    static int handle = -1;
    if(handle < 0)
        handle = iMA(_Symbol, PERIOD_M15, period, 0, MODE_EMA, PRICE_CLOSE);
    double buffer[];
    if(CopyBuffer(handle,0,shift,1,buffer)>0)
        return buffer[0];
    return 0;
}

// SL กันหน้าไม้
void BreakEven(double priceOpen, ulong ticket, int trigger, int offset)
{
    double bid = SymbolInfoDouble(_Symbol, SYMBOL_BID);
    double slCurrent = PositionGetDouble(POSITION_SL);
    double distance = bid - priceOpen;

    if(distance >= trigger * _Point)
    {
        double newSL = priceOpen + offset * _Point;
        if(newSL > slCurrent)
            trade.PositionModify(ticket, newSL, PositionGetDouble(POSITION_TP));
    }
}

// ตรวจสัญญาณ Buy ไม้แรก
bool IsBuySignal()
{
    double ema = GetEMA(emaPeriod,0);
    double bid = SymbolInfoDouble(_Symbol, SYMBOL_BID);
    Print("Bid=", bid, " EMA36=", ema); // debug
    return (bid >= ema - 0.5 && bid <= ema + 0.5);
}

// ตรวจว่าไม้แรกยังค้างอยู่หรือไม่
bool IsFirstBuyOpen()
{
    for(int i=0;i<PositionsTotal();i++)
    {
        if(PositionSelectByIndex(i))
        {
            if(PositionGetInteger(POSITION_TYPE) == POSITION_TYPE_BUY)
            {
                double openPrice = PositionGetDouble(POSITION_PRICE_OPEN);
                if(openPrice == lastBuyPrice1)
                    return true; // ไม้แรกยังเปิดอยู่
            }
        }
    }
    return false;
}

void OnTick()
{
    double bid = SymbolInfoDouble(_Symbol, SYMBOL_BID);

    // เปิดไม้แรก ถ้าไม้แรกยังไม่เปิด
    if(!IsFirstBuyOpen() && IsBuySignal())
    {
        double price = SymbolInfoDouble(_Symbol, SYMBOL_ASK);
        if(trade.Buy(lots1, _Symbol, price, price - slFirst*_Point, price + tpFirst*_Point))
        {
            lastBuyPrice1 = price;
            lastBuyPrice2 = 0; // รีเซ็ตไม้สอง
            Print("เปิดไม้แรก Buy ที่ ", price);
        }
    }

    // ปรับ SL กันหน้าไม้ไม้แรกและไม้สอง
    for(int i=0;i<PositionsTotal();i++)
    {
        ulong ticket = PositionGetTicket(i);
        if(PositionSelectByTicket(ticket))
        {
            double openPrice = PositionGetDouble(POSITION_PRICE_OPEN);
            if(openPrice == lastBuyPrice1)
                BreakEven(lastBuyPrice1, ticket, breakEvenFirst, breakEvenOffset);
            if(openPrice == lastBuyPrice2)
                BreakEven(lastBuyPrice2, ticket, breakEvenAddOn2, breakEvenOffset);
        }
    }

    // เปิดไม้สอง ถ้าราคาลง 500 จุดจากไม้แรก
    if(lastBuyPrice1 > 0 && lastBuyPrice2 == 0 && bid <= lastBuyPrice1 - 500*_Point)
    {
        double price = SymbolInfoDouble(_Symbol, SYMBOL_ASK);
        if(trade.Buy(lots2, _Symbol, price, price - slAddOn*_Point, price + tpAddOn*_Point))
        {
            lastBuyPrice2 = price;
            Print("เปิดไม้สอง Buy ที่ ", price);
        }
    }
}
