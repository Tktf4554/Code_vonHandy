#include <Trade/Trade.mqh>
CTrade trade;

input double lots           = 0.01;     // ขนาดล็อต
input int emaPeriod         = 36;       // EMA 36
input int takeProfit        = 3000;     // TP 3000 points
input int stopLoss          = 1000;     // SL 1000 points
input int breakevenTrigger  = 300;      // ราคาวิ่งไปกี่จุดถึงปรับ SL
input int breakevenOffset   = 100;      // SL ปรับสูงกว่าจุดเข้า
input double sellLots       = 0.01;     // ขนาด Sell สำหรับแก้ไม้

// อ่าน EMA36
double GetEMA(int period, int shift)
{
   int handle = iMA(_Symbol, PERIOD_M15, period, 0, MODE_EMA, PRICE_CLOSE);
   double buffer[];

   if(CopyBuffer(handle, 0, shift, 1, buffer) < 0)
      return 0;

   return buffer[0];
}

// เงื่อนไข Buy
bool IsBuySignal()
{
   double ema = GetEMA(emaPeriod, 0);
   double bid = SymbolInfoDouble(_Symbol, SYMBOL_BID);

   return (bid <= ema);
}

// ปรับ SL กันหน้าไม้
void BreakEvenSL()
{
   for(int i=0; i<PositionsTotal(); i++)
   {
      ulong ticket = PositionGetTicket(i);
      if(PositionSelectByTicket(ticket))
      {
         double priceOpen = PositionGetDouble(POSITION_PRICE_OPEN);
         double slCurrent = PositionGetDouble(POSITION_SL);
         double bid = SymbolInfoDouble(_Symbol, SYMBOL_BID);

         double distance = bid - priceOpen;

         if(distance >= breakevenTrigger * _Point)
         {
            double newSL = priceOpen + breakevenOffset * _Point;
            if(newSL > slCurrent)
               trade.PositionModify(ticket, newSL, PositionGetDouble(POSITION_TP));
         }
      }
   }
}

// ฟังก์ชันเปิด Sell แก้ไม้
void OpenSell()
{
   double price = SymbolInfoDouble(_Symbol, SYMBOL_BID);
   trade.Sell(sellLots, _Symbol, price, 0, 0); // Sell แบบไม่มี SL/TP
}

void OnTick()
{
   // ถ้ามีออเดอร์ Buy ค้างอยู่ → ไม่เปิด Buy เพิ่ม
   if(PositionsTotal() == 0 && IsBuySignal())
   {
      double price = SymbolInfoDouble(_Symbol, SYMBOL_ASK);
      trade.Buy(lots, _Symbol, price,
                price - stopLoss * _Point,
                price + takeProfit * _Point);
   }

   // ปรับ SL กันหน้าไม้
   if(PositionsTotal() > 0)
      BreakEvenSL();

   // ตัวอย่าง: เปิด Sell เพื่อแก้ไม้ กดปุ่มหรือเงื่อนไขอื่นก็ได้
   // OpenSell(); // เอาเครื่องหมาย // ออกถ้าต้องการให้ EA เปิด Sell อัตโนมัติ
}
