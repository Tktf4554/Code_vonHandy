#include <Trade/Trade.mqh>
CTrade trade;

input int lots1            = 0.2;          // ไม้แรก
input int lots2             = 0.2;           // SL ไม้สอง
input int emaPeriod           = 36;        // EMA 36
input int tpFirst             = 1000;      // TP ไม้แรก
input int slFirst             = 1000;      // SL ไม้แรก
input int breakEvenFirst      = 500;       // จุดขึ้นไปเพื่อ SL กันหน้าไม้ไม้แรก
input int breakEvenOffset     = 50;        // SL เลื่อนสูงกว่าเข้า

input int tpAddOn             = 500;       // TP ไม้สอง
input int slAddOn             = 1000;      // SL ไม้สอง
input int breakEvenAddOn2     = 200;       // จุดขึ้นไปเพื่อ SL กันหน้าไม้ไม้สอง

double lastBuyPrice1 = 0;
double lastBuyPrice2 = 0;

// อ่าน EMA36
double GetEMA(int period, int shift)
{
    double buffer[];
    int handle = iMA(_Symbol, PERIOD_M15, period, 0, MODE_EMA, PRICE_CLOSE);
    if(CopyBuffer(handle,0,shift,1,buffer)>0)
        return buffer[0];
    return 0;
}

// SL กันหน้าไม้
void BreakEven(double priceOpen, ulong ticket, int trigger)
{
    double bid = SymbolInfoDouble(_Symbol, SYMBOL_BID);
    double slCurrent = PositionGetDouble(POSITION_SL);
    double distance = bid - priceOpen;

    if(distance >= trigger * _Point)
    {
        double newSL = priceOpen + breakEvenOffset * _Point;
        if(newSL > slCurrent)
            trade.PositionModify(ticket, newSL, PositionGetDouble(POSITION_TP));
    }
}

bool IsBuySignal()
{
   double ema = GetEMA(emaPeriod, 0);
   double bid = SymbolInfoDouble(_Symbol, SYMBOL_BID);

   return (bid <= ema);
}
void OnTick()
{
   // เปิด Buy
   if(PositionsTotal() == 0 && IsBuySignal())
   {
      double price = SymbolInfoDouble(_Symbol, SYMBOL_ASK);
      trade.Buy(lots, _Symbol, price,
                price - slFirst * _Point,
                price + tpFirst * _Point);
   }
    // ปรับ SL กันหน้าไม้ไม้แรกและไม้สอง
    for(int i=0;i<PositionsTotal();i++)
    {
        ulong ticket = PositionGetTicket(i);
        if(PositionSelectByTicket(ticket))
        {
            double openPrice = PositionGetDouble(POSITION_PRICE_OPEN);
            if(openPrice == lastBuyPrice1)
                BreakEven(lastBuyPrice1, ticket, breakEvenFirst);
            if(openPrice == lastBuyPrice2)
                BreakEven(lastBuyPrice2, ticket, breakEvenAddOn2);
        }
    }

    // เปิดไม้สอง ถ้าราคาลง 500 จุดจากไม้แรก
    if(lastBuyPrice1 > 0 && lastBuyPrice2 == 0 && bid <= lastBuyPrice1 - 500*_Point)
    {
        double price = SymbolInfoDouble(_Symbol, SYMBOL_ASK);
        trade.Buy(lots, _Symbol, price, price - slAddOn*_Point, price + tpAddOn*_Point);
        lastBuyPrice2 = price;
    }
}
